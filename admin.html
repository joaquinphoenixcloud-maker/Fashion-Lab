<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="styleOOO.css"> 
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script> 
</head>
<body class="admin-body">

    <header class="admin-header">
        <div class="logo">Admin Panel</div>
        <div class="admin-nav-icons">
            <button class="order-btn" onclick="signOutAdmin()" style="margin-left:10px; background:#e74c3c;">Logout</button>
        </div>
    </header>

    <main class="admin-container">
        <div class="admin-sidebar">
            <div class="sidebar-item active" onclick="showSection('products')"><i class="fas fa-box"></i> Products</div>
            <div class="sidebar-item" onclick="showSection('orders')"><i class="fas fa-clipboard-list"></i> Orders</div>
            <div class="sidebar-item" onclick="showSection('settings')"><i class="fas fa-cog"></i> Settings</div>
        </div>

        <div class="admin-main-content">
            
            <section id="products-section" class="admin-section active">
                <h3>Product Management</h3>
                <button class="order-btn" onclick="openProductModal()" style="margin-bottom:20px;">Add New Product</button>
                <div id="productList" class="data-table">
                    </div>
            </section>
            
            <section id="orders-section" class="admin-section" style="display:none;">
                <h3>Order Management</h3>
                <div id="orderList" class="data-table">
                    </div>
            </section>
            
            <section id="settings-section" class="admin-section" style="display:none;">
                <h3>Settings</h3>
                <div class="setting-group">
                    <label for="darkModeToggle">Dark Mode</label>
                    <label class="switch">
                        <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode(this.checked)">
                        <span class="slider round"></span>
                    </label>
                </div>
                </section>
        </div>
    </main>
    
    <div class="modal" id="productModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal('productModal')">&times;</span>
            <h3 id="productModalTitle">Add Product</h3>
            
            <input type="hidden" id="productIdHidden">
            <div class="input-group">
                <label>Name</label>
                <input type="text" id="productNameInput" placeholder="Product Name">
            </div>
            <div class="input-group">
                <label>Description</label>
                <textarea id="productDescInput" rows="3" placeholder="Product details..."></textarea>
            </div>
            <div class="input-group">
                <label>Price (MMK)</label>
                <input type="number" id="productPriceInput" placeholder="10000">
            </div>
            <div class="input-group">
                <label>Category</label>
                <select id="productCategoryInput">
                    <option value="clothing">Clothing</option>
                    <option value="shoes">Shoes</option>
                    <option value="accessories">Accessories</option>
                </select>
            </div>
            <div class="input-group">
                <label>Image URL</label>
                <input type="text" id="productImageInput" placeholder="http://image-link.com/photo.jpg">
            </div>
            <div class="input-group">
                <label>Status</label>
                <label class="switch" style="display:block; margin-top:5px;">
                    <input type="checkbox" id="productActiveToggle" checked>
                    <span class="slider round"></span>
                </label>
            </div>
            
            <button class="order-btn" id="saveProductBtn" onclick="saveProduct()">Save Product</button>
        </div>
    </div>
    
    <div id="snackbar"></div>
    <script src="scriptOOO.js"></script>
    
    <script>
        // === AUTH CHECK AND INIT ===
        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAccess();
        });

        async function checkAdminAccess() {
            const { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                // Not logged in, redirect to login page
                window.location.href = 'admin-login.html';
                return;
            }

            // Check user role from profiles table
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('role')
                .eq('id', session.user.id)
                .single();

            if (error || profile.role !== 'admin') {
                showSnackbar('Access Denied: You do not have admin privileges.', true);
                await supabase.auth.signOut(); // Force sign out non-admins
                window.location.href = 'admin-login.html';
                return;
            }
            
            // Access granted. Load data.
            loadProductsAdmin();
            loadOrdersAdmin();
        }

        async function signOutAdmin() {
            // Reuses the shared sign out logic
            await signOutAndRedirect('admin-login.html');
        }

        // === ADMIN LOGIC ===

        function showSection(sectionId) {
            document.querySelectorAll('.admin-section').forEach(section => {
                section.style.display = 'none';
            });
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });

            document.getElementById(sectionId + '-section').style.display = 'block';
            document.querySelector(`.sidebar-item[onclick*="${sectionId}"]`).classList.add('active');
        }

        // --- PRODUCT CRUD ---

        let adminProducts = [];

        async function loadProductsAdmin() {
            const { data, error } = await supabase
                .from('products')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                document.getElementById('productList').innerHTML = `<p style="color:red;">Error loading products: ${error.message}</p>`;
                return;
            }
            adminProducts = data;
            renderProductsAdmin(data);
        }

        function renderProductsAdmin(products) {
            const list = document.getElementById('productList');
            if(products.length === 0) {
                 list.innerHTML = '<p>No products found.</p>';
                 return;
            }
            
            let html = `
                <div class="data-row header-row">
                    <div>Image</div>
                    <div>Name</div>
                    <div>Price</div>
                    <div>Category</div>
                    <div>Active</div>
                    <div>Actions</div>
                </div>
            `;
            products.forEach(p => {
                html += `
                    <div class="data-row">
                        <div class="data-cell"><img src="${p.image_url}" style="width:50px; height:50px; object-fit:cover;"></div>
                        <div class="data-cell">${p.name}</div>
                        <div class="data-cell">${p.price}</div>
                        <div class="data-cell">${p.category}</div>
                        <div class="data-cell">${p.is_active ? 'Yes' : 'No'}</div>
                        <div class="data-cell action-buttons">
                            <i class="fas fa-edit" onclick="editProduct('${p.id}')"></i>
                            <i class="fas fa-trash-alt" onclick="deleteProduct('${p.id}')" style="color:#e74c3c;"></i>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        function openProductModal(product = null) {
            document.getElementById('productModalTitle').textContent = product ? 'Edit Product' : 'Add Product';
            document.getElementById('productIdHidden').value = product ? product.id : '';
            document.getElementById('productNameInput').value = product ? product.name : '';
            document.getElementById('productDescInput').value = product ? product.description : '';
            document.getElementById('productPriceInput').value = product ? product.price : '';
            document.getElementById('productCategoryInput').value = product ? product.category : 'clothing';
            document.getElementById('productImageInput').value = product ? product.image_url : '';
            document.getElementById('productActiveToggle').checked = product ? product.is_active : true;
            document.getElementById('productModal').style.display = 'block';
        }

        function editProduct(productId) {
            const product = adminProducts.find(p => p.id === productId);
            if(product) {
                openProductModal(product);
            }
        }

        async function saveProduct() {
            const id = document.getElementById('productIdHidden').value;
            const is_active = document.getElementById('productActiveToggle').checked;
            
            const productData = {
                name: document.getElementById('productNameInput').value,
                description: document.getElementById('productDescInput').value,
                price: parseFloat(document.getElementById('productPriceInput').value),
                category: document.getElementById('productCategoryInput').value,
                image_url: document.getElementById('productImageInput').value,
                is_active: is_active
            };
            
            if (!productData.name || !productData.price || !productData.image_url) {
                showSnackbar('Please fill in Name, Price, and Image URL.', true);
                return;
            }

            document.getElementById('saveProductBtn').disabled = true;

            if (id) {
                // Update existing product
                const { error } = await supabase
                    .from('products')
                    .update(productData)
                    .eq('id', id);

                if (error) showSnackbar(`Update Failed: ${error.message}`, true);
                else showSnackbar('Product updated successfully!', false);
            } else {
                // Insert new product
                const { error } = await supabase
                    .from('products')
                    .insert([productData]);

                if (error) showSnackbar(`Insert Failed: ${error.message}`, true);
                else showSnackbar('Product added successfully!', false);
            }

            document.getElementById('saveProductBtn').disabled = false;
            closeModal('productModal');
            loadProductsAdmin();
        }

        async function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            
            const { error } = await supabase
                .from('products')
                .delete()
                .eq('id', productId);

            if (error) showSnackbar(`Delete Failed: ${error.message}`, true);
            else showSnackbar('Product deleted successfully!', false);

            loadProductsAdmin();
        }

        // --- ORDER MANAGEMENT ---

        let adminOrders = [];

        async function loadOrdersAdmin() {
            const { data, error } = await supabase
                .from('orders')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                document.getElementById('orderList').innerHTML = `<p style="color:red;">Error loading orders: ${error.message}</p>`;
                return;
            }
            adminOrders = data;
            renderOrdersAdmin(data);
        }

        function renderOrdersAdmin(orders) {
            const list = document.getElementById('orderList');
             if(orders.length === 0) {
                 list.innerHTML = '<p>No orders received yet.</p>';
                 return;
            }

            let html = `
                <div class="data-row header-row">
                    <div>Date</div>
                    <div>Product</div>
                    <div>Customer</div>
                    <div>Phone</div>
                    <div>Address</div>
                    <div>Slip</div>
                    <div>Status</div>
                </div>
            `;
            orders.forEach(o => {
                html += `
                    <div class="data-row order-row status-${o.status}">
                        <div class="data-cell">${new Date(o.created_at).toLocaleDateString()}</div>
                        <div class="data-cell">${o.product_name} x${o.quantity}</div>
                        <div class="data-cell">${o.customer_name}</div>
                        <div class="data-cell">${o.contact_phone}</div>
                        <div class="data-cell address-cell" title="${o.delivery_address}">${o.delivery_address.substring(0, 30)}...</div>
                        <div class="data-cell"><a href="${o.payment_slip_url}" target="_blank">View Slip</a></div>
                        <div class="data-cell">
                            <select onchange="updateOrderStatus('${o.id}', this.value)">
                                <option value="pending" ${o.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="coming" ${o.status === 'coming' ? 'selected' : ''}>Shipping</option>
                                <option value="owned" ${o.status === 'owned' ? 'selected' : ''}>Delivered</option>
                                <option value="reject" ${o.status === 'reject' ? 'selected' : ''}>Rejected</option>
                            </select>
                        </div>
                    </div>
                `;
            });
            list.innerHTML = html;
        }

        async function updateOrderStatus(orderId, newStatus) {
            const { error } = await supabase
                .from('orders')
                .update({ status: newStatus })
                .eq('id', orderId);

            if (error) showSnackbar(`Status Update Failed: ${error.message}`, true);
            else showSnackbar('Order status updated.', false);
            
            // Reload the orders list to reflect the change
            loadOrdersAdmin();
        }
        
        // --- SETTINGS ---
        function toggleDarkMode(isDark) {
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem('darkMode', isDark);
        }
        // Load settings on startup
        document.addEventListener('DOMContentLoaded', () => {
            const isDark = localStorage.getItem('darkMode') === 'true';
            document.getElementById('darkModeToggle').checked = isDark;
            document.body.classList.toggle('dark-mode', isDark);
        });
        
    </script>
</body>
</html>
